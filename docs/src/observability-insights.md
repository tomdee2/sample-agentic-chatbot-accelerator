# AgentCore Runtime Observability with CloudWatch Insights

This guide explains how to query and analyze AgentCore runtime logs using Amazon CloudWatch Insights. These queries help you monitor performance, track token usage, and troubleshoot agent behavior.

## Overview

When an AgentCore runtime is deployed, it automatically logs metrics and events to CloudWatch Logs. CloudWatch Insights provides a powerful query language to extract meaningful insights from these logs.

## How to Run Queries

1. Navigate to **CloudWatch** → **Logs** → **Logs Insights** in the AWS Console
2. Select your log group from the dropdown (typically `/aws/bedrock-agentcore/runtimes/<runtime-id>`)
3. Set the time range (e.g., last 1 hour, last 24 hours)
4. Paste the query into the query editor
5. Click **Run query**


## CloudWatch Insights Queries

### Token Usage Statistics

Track token consumption across your agent invocations. This is essential for **cost monitoring** and **understanding model usage patterns**.

```sql
fields agentMetrics.inputTokens, agentMetrics.outputTokens, agentMetrics.totalTokens
| filter ispresent(agentMetrics.inputTokens)
| stats avg(agentMetrics.inputTokens) as avgInputTokens,
        avg(agentMetrics.outputTokens) as avgOutputTokens,
        avg(agentMetrics.totalTokens) as avgTotalTokens,
        avg(agentMetrics.cacheReadInputTokens) as avgCacheReadInputTokens,
        avg(agentMetrics.cacheWriteInputTokens) as avgCacheWriteInputTokens,
        count(*) as totalRequests
```

**Metrics Explained:**
- `avgInputTokens` - Average tokens sent to the model per request
- `avgOutputTokens` - Average tokens generated by the model per request
- `avgTotalTokens` - Combined input + output tokens
- `avgCacheReadInputTokens` - Tokens retrieved from prompt cache (cost savings)
- `avgCacheWriteInputTokens` - Tokens written to prompt cache
- `totalRequests` - Number of agent invocations in the time range

### Deep Input Token Analysis

Get detailed statistical analysis of input token usage (e.g.) with percentile distributions. Useful for **capacity planning** and **identifying outliers**.

```sql
fields agentMetrics.inputTokens
| filter ispresent(agentMetrics.inputTokens)
| stats avg(agentMetrics.inputTokens) as avg,
        min(agentMetrics.inputTokens) as min,
        max(agentMetrics.inputTokens) as max,
        sum(agentMetrics.inputTokens) as total,
        pct(agentMetrics.inputTokens, 50) as p50,
        pct(agentMetrics.inputTokens, 95) as p95,
        pct(agentMetrics.inputTokens, 99) as p99,
        count(*) as requests
```

**Metrics Explained:**
- `avg`, `min`, `max` - Basic statistical measures
- `total` - Sum of all input tokens in the time range
- `p50` - Median (50th percentile) - typical request size
- `p95` - 95th percentile - most requests are below this
- `p99` - 99th percentile - identifies edge cases and potential issues

### Execution Time Analysis

Measure how long agent invocations take to complete. Critical for **performance monitoring** and **SLA tracking**.

```sql
fields @timestamp, @message
| parse @message /\((?<duration>\d+\.?\d*)s\)/
| filter ispresent(duration) and duration >= 1
| stats avg(duration * 1) as avg,
        min(duration * 1) as min,
        max(duration * 1) as max,
        sum(duration * 1) as total,
        pct(duration * 1, 50) as p50,
        pct(duration * 1, 95) as p95,
        pct(duration * 1, 99) as p99,
        count(*) as requests
```

**Metrics Explained:**
- `avg` - Average execution time in seconds
- `min`, `max` - Fastest and slowest requests
- `p50`, `p95`, `p99` - Percentile distribution for latency analysis
- `requests` - Total number of timed requests

> **Note:** This query filters out durations below 1 second to exclude heartbeat messages and only capture actual agent invocations. Adjust the threshold as needed (e.g., `duration >= 2` for stricter filtering).

### Successful Invocation Count

Track the number of successful agent invocations. Useful for **reliability monitoring** and **usage tracking**.

```sql
fields @timestamp, @message
| filter @message like /Invocation completed successfully/
| stats count(*) as total_invocations
```

**Use Cases:**
- Calculate success rates when combined with total invocation counts
- Monitor agent availability over time
- Validate deployments by confirming successful processing
